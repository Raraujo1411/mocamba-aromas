<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Moçamba Aromas</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
    }
    label {
      display: block;
      font-weight: bold;
      margin-top: 10px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #5c6bc0;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
    .negativo {
      background-color: #ffe5e5;
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Moçamba Aromas</h1>
    <h2>Registrar Venda</h2>
    <form>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
  <div style="flex: 1; min-width: 150px;">
    <label for="vendaAroma">Aroma:</label>
    <select id="vendaAroma">
      <option value="Alecrim">Alecrim</option>
      <option value="Baunilha">Baunilha</option>
      <option value="Flor de Cerejeira">Flor de Cerejeira</option>
      <option value="Lavanda">Lavanda</option>
    </select>
  </div>
  <div style="flex: 1; min-width: 100px;">
    <label for="vendaPeso">Peso:</label>
    <select id="vendaPeso">
      <option value="100">100g</option>
      <option value="160">160g</option>
    </select>
  </div>
  <div style="flex: 1; min-width: 80px;">
    <label for="vendaQuantidade">Quantidade:</label>
    <input type="number" id="vendaQuantidade" min="1" />
  </div>
</div>
<button type="button" onclick="registrarVenda()">Registrar Venda</button>
    </form>

    <h2>Adicionar Produto ao Estoque</h2>
<form>
  <div style="display: flex; gap: 10px; flex-wrap: wrap;">
    <div style="flex: 1; min-width: 150px;">
      <label for="aroma">Aroma:</label>
      <select id="aroma">
        <option value="Alecrim">Alecrim</option>
        <option value="Baunilha">Baunilha</option>
        <option value="Flor de Cerejeira">Flor de Cerejeira</option>
        <option value="Lavanda">Lavanda</option>
      </select>
    </div>
    <div style="flex: 1; min-width: 100px;">
      <label for="peso">Peso:</label>
      <select id="peso">
        <option value="100">100g</option>
        <option value="160">160g</option>
      </select>
    </div>
    <div style="flex: 1; min-width: 80px;">
      <label for="quantidade">Quantidade:</label>
      <input type="number" id="quantidade" min="1" />
    </div>
  </div>
  <label for="local">Local:</label>
  <input type="text" id="local" />

      <button type="button" onclick="alterarEstoque(true)">Adicionar</button>
      <button type="button" onclick="alterarEstoque(false)">Remover</button>
    </form>

    <button onclick="zerarEstoque()" style="background:red">Zerar Estoque</button>
    <button onclick="zerarVendas()" style="background:darkred">Zerar Vendas</button>

    <h2>Estoque Atual</h2>
    <table>
      <thead>
        <tr>
          <th>Aroma</th>
          <th>Peso</th>
          <th>Quantidade</th>
          <th>Valor (R$)</th>
          <th>Local</th>
        </tr>
      </thead>
      <tbody id="tabelaEstoque"></tbody>
      <tfoot>
        <tr style="font-weight:bold; background:#f0f0f0">
          <td colspan="2">Totais</td>
          <td id="totalQtd"></td>
          <td id="totalVal"></td>
          <td>-</td>
        </tr>
      </tfoot>
    </table>

    <h2>Histórico de Vendas</h2>
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Aroma</th>
          <th>Peso</th>
          <th>Qtd</th>
          <th>Valor (R$)</th>
        </tr>
      </thead>
      <tbody id="tabelaVendas"></tbody>
    </table>
  </div>

  <script>
    const webAppURL = "https://script.google.com/macros/s/AKfycby1N0n9s7dJEfBXmBZvbkzws1TvgLF_F_VojMT1AV8/exec";

    let estoque = {};
    let vendas = [];

    async function carregarEstoqueDaNuvem() {
      return fetch(webAppURL + "?tipo=Estoque")
        .then(res => res.json())
        .then(data => {
          estoque = {};
          data.forEach(([aroma, peso, local, qtd]) => {
            const chave = `${aroma}_${peso}_${local}`;
            estoque[chave] = parseInt(qtd);
          });
          localStorage.setItem("estoqueVelas", JSON.stringify(estoque));
          atualizarTabela();
        });
    }

    async function carregarVendasDaNuvem() {
      return fetch(webAppURL + "?tipo=Vendas")
        .then(res => res.json())
        .then(data => {
          vendas = data.map(([data, aroma, peso, qtd, valor]) => ({
            data, aroma, peso, quantidade: parseInt(qtd), valorTotal: parseFloat(valor)
          }));
          localStorage.setItem("vendasVelas", JSON.stringify(vendas));
          atualizarVendas();
        });
    }

    function salvarEstoqueNaNuvem() {
      const dados = Object.entries(estoque).map(([chave, qtd]) => {
        const [aroma, peso, local] = chave.split("_");
        return [aroma, peso, local, qtd];
      });
      fetch(webAppURL + "?tipo=Estoque", {
        method: "POST",
        body: JSON.stringify(dados)
      });
    }

    function salvarVendasNaNuvem() {
      const dados = vendas.map(v => [v.data, v.aroma, v.peso, v.quantidade, v.valorTotal]);
      fetch(webAppURL + "?tipo=Vendas", {
        method: "POST",
        body: JSON.stringify(dados)
      });
    }

    function alterarEstoque(adicionar) {
      const aroma = document.getElementById("aroma").value;
      const peso = document.getElementById("peso").value;
      let local = document.getElementById("local").value.trim();
      if (!local) local = "GERACAO VITAL";
      const quantidadeInput = document.getElementById("quantidade").value;

      if (!quantidadeInput || isNaN(quantidadeInput) || parseInt(quantidadeInput) <= 0) {
        alert("Quantidade não informada.");
        return;
      }

      const quantidade = parseInt(quantidadeInput);
      const chave = `${aroma}_${peso}_${local}`;
      estoque[chave] = estoque[chave] || 0;
      estoque[chave] = adicionar ? estoque[chave] + quantidade : estoque[chave] - quantidade;

      atualizarTabela();
      salvarEstoqueNaNuvem();
    }

    function registrarVenda() {
      const aroma = document.getElementById("vendaAroma").value;
      const peso = parseInt(document.getElementById("vendaPeso").value);
      const quantidadeInput = document.getElementById("vendaQuantidade").value;

      if (!quantidadeInput || isNaN(quantidadeInput) || parseInt(quantidadeInput) <= 0) {
        alert("Quantidade não informada.");
        return;
      }

      const quantidade = parseInt(quantidadeInput);
      const valorUnit = peso === 160 ? 65 : 45;
      const valorTotal = valorUnit * quantidade;

      let chave = Object.keys(estoque).find(k => k.startsWith(`${aroma}_${peso}_`));
      if (!chave) {
        const local = "Indefinido";
        chave = `${aroma}_${peso}_${local}`;
        estoque[chave] = 0;
      }

      estoque[chave] -= quantidade;

      const data = new Date().toLocaleDateString("pt-BR");
      vendas.unshift({ data, aroma, peso, quantidade, valorTotal });

      localStorage.setItem("estoqueVelas", JSON.stringify(estoque));
      localStorage.setItem("vendasVelas", JSON.stringify(vendas));

      atualizarTabela();
      atualizarVendas();
      salvarEstoqueNaNuvem();
      salvarVendasNaNuvem();
    }

    function atualizarTabela() {
      const tbody = document.getElementById("tabelaEstoque");
      tbody.innerHTML = "";
      let totalQtd = 0;
      let totalVal = 0;

      for (const chave in estoque) {
        const [aroma, peso, local] = chave.split("_");
        const qtd = estoque[chave];
        const valor = qtd * (parseInt(peso) === 160 ? 65 : 45);
        totalQtd += qtd;
        totalVal += valor;

        tbody.innerHTML += `
          <tr class="${qtd < 0 ? 'negativo' : ''}">
            <td>${aroma}</td>
            <td>${peso}g</td>
            <td>${qtd}</td>
            <td>R$ ${valor.toFixed(2)}</td>
            <td>${local}</td>
          </tr>`;
      }

      document.getElementById("totalQtd").textContent = totalQtd;
      document.getElementById("totalVal").textContent = "R$ " + totalVal.toFixed(2);
    }

    function atualizarVendas() {
      const tbody = document.getElementById("tabelaVendas");
      tbody.innerHTML = "";
      vendas.forEach(v => {
        tbody.innerHTML += `
          <tr>
            <td>${v.data}</td>
            <td>${v.aroma}</td>
            <td>${v.peso}g</td>
            <td>${v.quantidade}</td>
            <td>R$ ${v.valorTotal.toFixed(2)}</td>
          </tr>`;
      });
    }

    function zerarEstoque() {
  const senha = prompt("Digite a senha para zerar o estoque:");
  if (senha !== "1234") {
    alert("Senha incorreta.");
    return;
  }
  if (confirm("Tem certeza que deseja zerar o estoque?")) {
    estoque = {};
    atualizarTabela();
    salvarEstoqueNaNuvem();
  }
};
        atualizarTabela();
        salvarEstoqueNaNuvem();
      }
    }

    function zerarVendas() {
  const senha = prompt("Digite a senha para zerar as vendas:");
  if (senha !== "1234") {
    alert("Senha incorreta.");
    return;
  }
  if (confirm("Tem certeza que deseja apagar todas as vendas?")) {
    vendas = [];
    atualizarVendas();
    salvarVendasNaNuvem();
  }
}
    }

    async function iniciarApp() {
      await carregarEstoqueDaNuvem();
      await carregarVendasDaNuvem();
    }

    iniciarApp();

    setInterval(() => {
      carregarEstoqueDaNuvem();
      carregarVendasDaNuvem();
    }, 15000);
  </script>
</body>
</html>
