<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Moçamba Aromas - Estoque</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
    }
    label {
      margin-top: 10px;
      display: block;
      font-weight: bold;
    }
    select, input, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #5c6bc0;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #eee;
    }
    .negativo {
      background-color: #ffe5e5;
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Moçamba Aromas</h1>

    <label><input type="checkbox" id="permitirNegativo" onchange="localStorage.setItem('estoqueNegativo', this.checked)"> Permitir estoque negativo</label>

    <h2>Registrar Venda</h2>
    <form id="vendaForm">
      <label for="cliente">Cliente (opcional):</label>
      <input type="text" id="cliente" placeholder="Nome do cliente" />

      <label for="vendaAroma">Aroma:</label>
      <select id="vendaAroma">
        <option value="Baunilha">Baunilha</option>
        <option value="Lavanda">Lavanda</option>
        <option value="Alecrim">Alecrim</option>
        <option value="Flor de Cerejeira">Flor de Cerejeira</option>
      </select>

      <label for="vendaPeso">Peso:</label>
      <select id="vendaPeso">
        <option value="100">100g</option>
        <option value="160">160g</option>
      </select>

      <label for="vendaQuantidade">Quantidade:</label>
      <input type="number" id="vendaQuantidade" min="1" required />

      <button type="button" onclick="registrarVenda()">Registrar Venda</button>
    </form>

    <h2>Filtro de Vendas</h2>
    <input type="text" id="filtroCliente" placeholder="Filtrar por cliente" oninput="atualizarVendas()" />
    <input type="date" id="filtroData" oninput="atualizarVendas()" />

    <h2>Estoque Atual</h2>
    <table>
      <thead>
        <tr>
          <th>Aroma</th>
          <th>Peso</th>
          <th>Quantidade</th>
        </tr>
      </thead>
      <tbody id="tabelaEstoque"></tbody>
    </table>

    <h2>Histórico de Vendas</h2>
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Cliente</th>
          <th>Aroma</th>
          <th>Peso</th>
          <th>Qtd</th>
          <th>Valor (R$)</th>
        </tr>
      </thead>
      <tbody id="tabelaVendas"></tbody>
    </table>
  </div>

  <script>
    const estoque = JSON.parse(localStorage.getItem("estoqueVelas")) || {};
    const vendas = JSON.parse(localStorage.getItem("vendasVelas")) || [];
    const permitirNegativo = localStorage.getItem("estoqueNegativo") === "true";
    document.getElementById("permitirNegativo").checked = permitirNegativo;

    function registrarVenda() {
      const cliente = document.getElementById("cliente").value;
      const aroma = document.getElementById("vendaAroma").value;
      const peso = parseInt(document.getElementById("vendaPeso").value);
      const quantidade = parseInt(document.getElementById("vendaQuantidade").value);
      const valorUnitario = peso === 160 ? 65 : 45;
      const valorTotal = valorUnitario * quantidade;
      const chave = `${aroma}_${peso}`;

      estoque[chave] = parseInt(estoque[chave]) || 0;
      const novoEstoque = estoque[chave] - quantidade;

      if (!permitirNegativo && novoEstoque < 0) {
        alert("Estoque insuficiente para esta venda!");
        return;
      }

      estoque[chave] = novoEstoque;

      const data = new Date().toLocaleString("pt-BR");
      vendas.unshift({ data, cliente, aroma, peso, quantidade, valorTotal });
      if (vendas.length > 100) vendas.pop();

      localStorage.setItem("estoqueVelas", JSON.stringify(estoque));
      localStorage.setItem("vendasVelas", JSON.stringify(vendas));
      atualizarTabela();
      atualizarVendas();
    }

    function atualizarTabela() {
      const tbody = document.getElementById("tabelaEstoque");
      tbody.innerHTML = "";
      for (const chave in estoque) {
        const [aroma, peso] = chave.split("_");
        const qtd = estoque[chave];
        const row = `<tr class="${qtd < 0 ? 'negativo' : ''}"><td>${aroma}</td><td>${peso}g</td><td>${qtd}</td></tr>`;
        tbody.innerHTML += row;
      }
    }

    function atualizarVendas() {
      const tbody = document.getElementById("tabelaVendas");
      const filtroCliente = document.getElementById("filtroCliente").value.toLowerCase();
      const filtroData = document.getElementById("filtroData").value;
      tbody.innerHTML = "";
      vendas.forEach((venda) => {
        if (
          (filtroCliente && !venda.cliente?.toLowerCase().includes(filtroCliente)) ||
          (filtroData && !venda.data.includes(filtroData))
        ) return;

        const row = `<tr>
          <td>${venda.data}</td>
          <td>${venda.cliente || "-"}</td>
          <td>${venda.aroma}</td>
          <td>${venda.peso}g</td>
          <td>${venda.quantidade}</td>
          <td>R$ ${venda.valorTotal.toFixed(2)}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    atualizarTabela();
    atualizarVendas();

    // Botão de relatório por data
    document.addEventListener("DOMContentLoaded", () => {
      const relatorioBtn = document.createElement("button");
      relatorioBtn.textContent = "Gerar Relatório por Data";
      relatorioBtn.style.marginTop = "15px";
      relatorioBtn.style.padding = "10px";
      relatorioBtn.style.backgroundColor = "#388e3c";
      relatorioBtn.style.color = "white";
      relatorioBtn.style.border = "none";
      relatorioBtn.style.borderRadius = "5px";
      relatorioBtn.style.fontWeight = "bold";
      relatorioBtn.onclick = () => {
        const dataFiltro = prompt("Digite a data no formato DD/MM/AAAA:");
        if (!dataFiltro) return;

        const vendasFiltradas = vendas.filter(v => v.data.startsWith(dataFiltro));
        if (vendasFiltradas.length === 0) {
          alert("Nenhuma venda encontrada para essa data.");
          return;
        }

        let totalDia = 0;
        let relatorio = `Relatório de Vendas - ${dataFiltro}\n\n`;
        relatorio += "Cliente\tAroma\tPeso\tQtd\tValor\n";
        relatorio += "--------------------------------------------------\n";

        vendasFiltradas.forEach(v => {
          relatorio += `${v.cliente || '-'}\t${v.aroma}\t${v.peso}g\t${v.quantidade}\tR$ ${v.valorTotal.toFixed(2)}\n`;
          totalDia += v.valorTotal;
        });

        relatorio += "--------------------------------------------------\n";
        relatorio += `Total do Dia: R$ ${totalDia.toFixed(2)}`;

        alert(relatorio);
      };

      document.body.appendChild(relatorioBtn);
    });
  </script>
</body>
</html>